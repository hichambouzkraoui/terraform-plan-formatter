name: Release

on:
  push:
    tags: ['v*']
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release'
        required: true
        type: string

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - run: cargo test --all-features
      - run: cargo clippy -- -D warnings
      - run: cargo fmt --check

  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - run: cargo install cargo-audit
      - run: cargo audit

  build:
    needs: [test, security]
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            archive: tar.gz
          - os: macos-latest
            target: x86_64-apple-darwin
            archive: tar.gz
          - os: macos-latest
            target: aarch64-apple-darwin
            archive: tar.gz
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            archive: zip

    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.target }}
      
      - run: cargo build --release --target ${{ matrix.target }}
      
      - name: Package Unix
        if: matrix.archive == 'tar.gz'
        run: |
          name=tfplan-${{ github.ref_name }}-${{ matrix.target }}
          mkdir $name
          cp target/${{ matrix.target }}/release/tfplan $name/
          cp README.md LICENSE $name/ 2>/dev/null || true
          tar -czf $name.tar.gz $name
          echo "ASSET=$name.tar.gz" >> $GITHUB_ENV
      
      - name: Package Windows
        if: matrix.archive == 'zip'
        run: |
          $name = "tfplan-${{ github.ref_name }}-${{ matrix.target }}"
          mkdir $name
          cp "target/${{ matrix.target }}/release/tfplan.exe" "$name/"
          cp README.md $name/ -ErrorAction SilentlyContinue
          Compress-Archive -Path $name -DestinationPath "$name.zip"
          echo "ASSET=$name.zip" >> $env:GITHUB_ENV
      
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.target }}
          path: ${{ env.ASSET }}

  release:
    needs: build
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.release.outputs.upload_url }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
      
      - name: Create Release
        id: release
        uses: softprops/action-gh-release@v2
        with:
          files: '**/*'
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}

  publish-crates:
    needs: release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - run: cargo publish --token ${{ secrets.CARGO_REGISTRY_TOKEN }}

  publish-homebrew:
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Update Homebrew Formula
        uses: dawidd6/action-homebrew-bump-formula@v3
        with:
          token: ${{ secrets.HOMEBREW_TOKEN }}
          formula: tfplan

  publish-chocolatey:
    needs: release
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Pack and Push to Chocolatey
        run: |
          choco pack tfplan.nuspec
          choco push --source https://push.chocolatey.org/ --api-key ${{ secrets.CHOCOLATEY_API_KEY }}

  publish-aur:
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Update AUR Package
        uses: KSXGitHub/github-actions-deploy-aur@v2.7.2
        with:
          pkgname: tfplan
          pkgbuild: ./PKGBUILD
          commit_username: ${{ secrets.AUR_USERNAME }}
          commit_email: ${{ secrets.AUR_EMAIL }}
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}

  publish-snap:
    needs: release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: snapcore/action-build@v1
        id: build
      - uses: snapcore/action-publish@v1
        with:
          snap: ${{ steps.build.outputs.snap }}
          release: stable
        env:
          SNAPCRAFT_STORE_CREDENTIALS: ${{ secrets.SNAPCRAFT_TOKEN }}